<!DOCTYPE html>
{% load static %}
{% load crispy_forms_tags %}
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  {% include 'messages/messages.html' %}
  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<!-- ADD THE CLASS fixed TO GET A FIXED HEADER AND SIDEBAR LAYOUT -->
<!-- the fixed layout is not compatible with sidebar-mini -->
<body class="hold-transition skin-blue fixed sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

  {% include 'Components/AdminSidebar.html' %}
  {% include 'Components/AdminNavbar.html' %}

  <!-- =============================================== -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1 class="text-center">
      </h1>
      <ol class="breadcrumb">
        <li><a href="{% url 'AdminDashboard' %}"><i class="fa fa-dashboard"></i>Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'AdminUserManagement' %}">User Management</a></li>
        <li class="breadcrumb-item active">User Groups</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
<!--        <div class="col-xs-3"></div>-->
        <div class="col-xs-8">
          <div class="box box-outline box-info">
            <div class="box-header">
              <div class="box-title">
                <h4>Assign User Permissions</h4>
              </div>
            </div>
              <div class="box-body">
                <div class="row">
                  <div class="col-xs-6">
                    <div class="form-group">
                      <label for="selectedGroup">Groups</label>
                      <select class="form-control" id="selectedGroup">
                        <option value="">Please Select a Group</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-xs-12">
                    <div class="form-group">
                      <label>Permissions</label>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-xs-5">
                    <div class="form-group">
                      <input type="text" id="search-left" onkeyup="filterOptions('left')" placeholder="search..."  class="form-control"/><br/>
                      <select class="form-control" id="left-panel" multiple="multiple" size="10"></select>
                    </div>
                  </div>
                  <div class="col-xs-2"><br/><br/>
                    <div class="duallist-buttons">
                      `<button id="btnright" type="button" class="btn btn-block">&gt;</button>
                      <button id="btnleft" type="button" class="btn btn-block">&lt;</button>
                      <button id="btnrightall" type="button" class="btn btn-block">&gt;&gt;</button>
                      <button id="btnleftall" type="button" class="btn btn-block">&lt;&lt;</button>
                    </div>`
                  </div>
                  <div class="col-xs-5">
                    <div class="form-group">
                      <input type="text" id="search-right" onkeyup="filterOptions('right')" placeholder="search..."  class="form-control"/><br/>
                      <select class="form-control" id="right-panel" multiple="multiple" size="10"></select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="box-footer">
                <div class="row">
                  <div class="col-xs-6">
                    <button type="button" id="btnSave" class="btn btn-success btn-block">Save</button>
                  </div>
                </div>
              </div>
          </div>
        </div>
      </div>
    </section>
    <!-- /.content -->
  </div>
</div>
<!-- ./wrapper -->
</body>
</html>
<script>
  fetch('/Admin/UserPermissions/').then(response => response.json())
  .then(data => {
    const groups = document.getElementById('selectedGroup');
    data.forEach(group => {
      const option = document.createElement('option');
      option.value = group.name;
      option.textContent = group.name;
      groups.appendChild(option)
    })

    document.getElementById('selectedGroup').addEventListener('change', function () {
      const selectedGroup = this.value;
      const selectedPermissions = data.find(group => group.name === selectedGroup).permissions;
      const selectedPermissionsList = document.getElementById('right-panel');
      const availablePermissionsList = document.getElementById('left-panel');

      selectedPermissionsList.innerHTML = '';
      availablePermissionsList.innerHTML = '';

      selectedPermissions.forEach(permission => {
        const option = document.createElement('option');
        option.value = permission;
        option.textContent = permission;
        selectedPermissionsList.appendChild(option);
      });
      fetch('/Admin/FetchPermissions/').then(response => response.json())
      .then(data => {
          const all_permissions = data.all_permissions
          all_permissions.forEach(permission => {
          if (!selectedPermissions.includes(permission)){
              const option = document.createElement('option');
              option.value = permission;
              option.textContent = permission;
              availablePermissionsList.appendChild(option);
          }
        });
      })
    });
  })
</script>
<script>
  function filterOptions(panel) {
    let input = document.getElementById("search-" +panel);
    let select = document.getElementById(panel+ "-panel");

    let filter = input.value.toUpperCase();

    for (let i=0; i < select.options.length; i++){
      let option = select.options[i];
      let text = option.text.toUpperCase();

      if (text.indexOf(filter) > -1){
        option.style.display = "";
      }else{
        option.style.display = "none";
      }
    }
  }
  $(document).ready(function() {
    $('#btnright').click(function (e) {
      let selectedoptions = $('#left-panel option:selected');
      if (selectedoptions.length === 0) {
        alert('Nothing to move');
        e.preventDefault();
      }
      $('#right-panel').append($(selectedoptions).clone());
      $(selectedoptions).remove();
      e.preventDefault()
    });
    $('#btnleft').click(function (e) {
      let selectedoptions = $('#right-panel option:selected');
      if (selectedoptions.length === 0) {
        alert('Nothing to move');
        e.preventDefault();
      }
      $('#left-panel').append($(selectedoptions).clone());
      $(selectedoptions).remove();
      e.preventDefault();
    });
    $('#btnrightall').click(function (e) {
      let alloptions = $('#left-panel option');
      if (alloptions.length === 0) {
        alert("Nothing to move");
        e.preventDefault();
      }
      $('#right-panel').append($(alloptions).clone());
      $(alloptions).remove();
      e.preventDefault();
    });
    $('#btnleftall').click(function (e) {
      let alloptions = $('#right-panel option');
      if (alloptions.length === 0) {
        alert("Nothing to move");
        e.preventDefault();
      }
      $('#left-panel').append($(alloptions).clone());
      $(alloptions).remove();
      e.preventDefault();
    });
    function save_to_db(e){
      let groupSelect = document.getElementById('selectedGroup')
      let SelectedGroup = groupSelect.value;
      let SelectedPerms = Array.from(document.getElementById('right-panel').options).map(option => option.value);
      let RemovedPerms = Array.from(document.getElementById('left-panel').options).map(option => option.value);
      RemovedPerms = JSON.stringify(RemovedPerms)
      SelectedPerms = JSON.stringify(SelectedPerms)
      $.ajax({
        url: '{% url "UpdatePermissions" %}',
        type: 'POST',
        data: {SelectedPerms: SelectedPerms, RemovedPerms:RemovedPerms, SelectedGroup:SelectedGroup},
        success: function (response) {
          alert("Permissions Updated")
          e.preventDefault()
        },
        error: function () {
          alert('Failed')
        }
      });
    }

    document.getElementById('btnSave').addEventListener("click", save_to_db)
  });
</script>
