<!DOCTYPE html>
{% load static %}
{% load filename %}
{% load crispy_forms_tags %}
<html>
<head>
  <meta charset="utf-8">
  <meta name="csrf-token" content="{{csrf_token}}">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
  {% include 'messages/messages.html' %}
  {% include 'scripts/css.html' %}
  <!-- Google Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
</head>
<body class="hold-transition skin-blue fixed sidebar-mini">
<div class="wrapper">

  {% include 'STDComponents/Navbar.html' %}
  {% include 'STDComponents/Sidebar.html' %}

  <!-- =============================================== -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <ol class="breadcrumb">
        <li><a href="{% url 'STDDashboard' %}"><i class="fa fa-dashboard"></i>Dashboard</a></li>
        <li><a href="">InterSchool Transfer</a></li>
      </ol>
    </section>
    <section class="content">
      <div class="row">
          <div class="col-xs-8">
            <div class="box box-outline box-success">
              <div class="box-header">
                <div class="box-title"><h4>InterSchool Transfer Form</h4></div>
              </div>
              <div class="box-body">
                  <div class="row">
                    <div class="col-xs-12">
                        <label>Current Programme</label>
                       <input type="text" value="{{student.course.name}}" disabled class="form-control" />
                      {{form.new_programme|as_crispy_field}}
                      {{form.reason|as_crispy_field}}
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-xs-12">
                      <div class="box-body">
                        <div class="panel panel-danger">
                          <div class="panel-heading"><i class="fa fa-graduation-cap"></i> KCSE Results</div>
                          <div class="panel-body">
                              <form action="{% url 'AddSubject' %}" method="post">
                                  {% csrf_token %}
                                  <div class="row">
                                    <div class="col-xs-12">
                                        {{form2.subject|as_crispy_field}}
                                        {{form2.grade|as_crispy_field}}
                                      </div>
                                    </div>
                                    <div class="row">
                                      <div class="col-xs-12">
                                          <button type="submit" class="btn btn-primary btn-sm pull-right">Add</button>
                                      </div>
                                    </div>
                              </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="panel">
                      <div class="row">
                        <div class="col-xs-12">
                          <table id="semester_list" class="table">
                              <thead>
                                  <tr>
                                      <th>Subject</th>
                                      <th>Grade</th>
                                      <th></th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {% for instance in queryset %}
                                      <tr>
                                          <td>{{instance.subject}}</td>
                                          <td>{{instance.grade}}</td>
                                          <td>
                                              <a href="{% url 'DeleteSubject' instance.id %}">Remove</a>
                                          </td>
                                      </tr>
                                  {% endfor %}
                              </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-xs-6">
                      {{form.aggregate|as_crispy_field}}
                    </div>
                  </div>
                      <form action="{% url 'UploadResultSlip' %}" method="post" enctype="multipart/form-data">
                          {% csrf_token %}
                          <div class="row">
                              <div class="col-xs-6">
                                  {{form3.kcse_result_slip|as_crispy_field}}
                              </div>
                          </div>
                          <div class="row">
                              <div class="col-xs-6">
                                  <button type="submit" class="btn btn-info btn-block">Upload Result Slip</button>
                              </div>
                              <div class="col-xs-6">
                                  <button type="button" id="submit" class="btn btn-info btn-block">Submit Application</button>
                              </div>
                          </div>
                      </form>
                  <div class="row">
                      <div class="col-xs-12">
                          <div class="card-body">
                              <div class="panel">
                                  <div class="panel-heading"><h4>My Application(s) History</h4>
                                    <p class="text-red">NOTE: Once a course transfer is approved, then you should see the Dean of the faculty in which the course
                                        is located.
                                    </p>
                                      <p class="text-red">NOTE: Even if you submit more than one transfer request, only one of the
                                        requests in which you highly qualify will be approved.
                                      </p>
                                  </div>
                                  <table id="applications" class="table">
                                      <thead>
                                          <tr>
                                              <th>Course</th>
                                              <th>ResultSlip</th>
                                              <th>status</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          {% for instance in my_applications %}
                                              <tr>
                                                  <td>{{instance.new_programme.name}}</td>
                                                  <td>
                                                      <i class="fa fa-file-pdf-o"></i>&nbsp;<a href="{% url 'download_result_slip' result_slip.student.hashid %}">{{result_slip.kcse_result_slip|name}}</a>
                                                  </td>
                                                  <td>
                                                      {% if instance.status == 'pending' %}
                                                          <span class="label bg-blue">Pending</span>
                                                     {% elif instance.status == 'approved' %}
                                                          <span class="label bg-green">Approved</span>
                                                     {% elif instance.status == 'rejected' %}
                                                          <span class="label bg-red">Rejected</span>
                                                     {% endif %}
                                                  </td>
                                              </tr>
                                          {% endfor %}
                                      </tbody>
                                  </table>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
            </div>
          </div>
        </div>
    </section>
  </div>
</div>
</body>
</html>
<script>
$(document).ready(function(){
  $(document).on("click","#submit",function(){
      $.ajaxSetup({
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        }
      });
      var new_programme=$("#id_new_programme").val();
      var aggregate=$("input[type='text'][name='aggregate']").val();
      var reason=$("input[type='text'][name='reason']").val();
      $.ajax({
        url: '{% url 'SubmitTransferRequest' %}',
        type: 'POST',
        data: {aggregate:aggregate, new_programme:new_programme, reason:reason},
        success: function(response){
            if(response=="Submitted"){
              Swal.fire(
                 '',
                 'Submitted',
                 'success',
              ).then(() => {
                location.reload()
              })
            }

            if(response=="Exists"){
              Swal.fire(
                 '',
                 'You cannot apply for a course that you are enrolled in',
                 'warning',
              ).then(() => {
                location.reload()
              })
            }

            if(response=="Failed"){
              Swal.fire(
                 '',
                 'Failed to submit',
                 'error',
              ).then(() => {
                location.reload()
              })
            }
        }
      })
  })
})
</script>